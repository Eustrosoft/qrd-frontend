@if (!selectors.isTemplateLoading()) {
  <card-container [hideHeading]="true">
    <ng-container content>
      <toolbar>
        @if (!isSmallScreen()) {
          <ng-container heading>
            <h1>{{ templateId ? TemplatesLocalization.editing : TemplatesLocalization.creation }}</h1>
          </ng-container>
        }
        <ng-container action-buttons>
          @if (!selectors.isSaveInProgress()) {
            <button (click)="saveData()" class="button-md" mat-flat-button>
              {{ SharedLocalization.save }}
            </button>
          } @else {
            <ui-skeleton height="40" width="128" />
          }
        </ng-container>
      </toolbar>
    </ng-container>
  </card-container>
  <card-container>
    <ng-container heading>
      <h1>{{ RouteTitles.template }}</h1>
    </ng-container>
    <ng-container content>
      <ui-grid-block gridAlignItems="start" [gridTemplateColumns]="gridTemplateColumns()">
        <mat-form-field class="form-field-lg">
          <mat-label> {{ SharedLocalization.name }} </mat-label>
          <input [formControl]="form.controls.name" matInput />
          @if (form.controls.name.touched && form.controls.name.hasError('required')) {
            <mat-error>{{ SharedLocalization.fieldRequired }}</mat-error>
          }
          @if (form.controls.name.touched && form.controls.name.hasError('maxlength')) {
            <mat-error>{{ SharedLocalization.maxLength }} {{ MAX_NAME_LENGTH }}</mat-error>
          }
        </mat-form-field>
        <mat-form-field class="form-field-lg">
          <mat-label> {{ SharedLocalization.description }} </mat-label>
          <textarea [formControl]="form.controls.description" matInput></textarea>
          @if (form.controls.description.touched && form.controls.description.hasError('required')) {
            <mat-error>{{ SharedLocalization.fieldRequired }}</mat-error>
          }
          @if (form.controls.description.touched && form.controls.description.hasError('maxlength')) {
            <mat-error>{{ SharedLocalization.maxLength }} {{ MAX_DESCRIPTION_LENGTH }}</mat-error>
          }
        </mat-form-field>
      </ui-grid-block>
    </ng-container>
  </card-container>
  <card-container>
    <ng-container heading>
      <h1>{{ RouteTitles.attrs }}</h1>
    </ng-container>
    <ng-container content>
      @for (field of form.controls.fields.controls; track field) {
        <ui-flex-block flexAlignItems="center">
          <mat-form-field class="form-field-lg" style="flex: auto">
            <mat-label> {{ SharedLocalization.name }} </mat-label>
            <input [formControl]="field.controls.caption" matInput />
          </mat-form-field>
          <button (click)="showAdditionalFields($index)" class="icon-button-sm" mat-icon-button>
            <mat-icon class="icon-primary">edit_square</mat-icon>
          </button>
          <button (click)="deleteField($index)" class="icon-button-sm" mat-icon-button>
            <mat-icon class="icon-primary">delete_forever</mat-icon>
          </button>
        </ui-flex-block>
        @if (expandedFieldIndex() === $index) {
          <ui-grid-block gridAlignItems="center" [gridTemplateColumns]="expandedFieldsGridTemplateColumns()">
            <mat-form-field class="form-field-lg">
              <mat-label>{{ TemplatesLocalization.dataType }}</mat-label>
              <mat-select [formControl]="field.controls.fieldType">
                @for (type of selectors.inputType().list; track type.value) {
                  <mat-option [value]="type.value">
                    {{ type.description }}
                  </mat-option>
                }
              </mat-select>
            </mat-form-field>
            <mat-form-field class="form-field-lg">
              <mat-label>{{ SharedLocalization.value }}</mat-label>
              <input [formControl]="field.controls.placeholder" matInput />
            </mat-form-field>
            <mat-form-field class="form-field-lg">
              <mat-label>{{ TemplatesLocalization.position }}</mat-label>
              <input [formControl]="field.controls.fieldOrder" matInput />
            </mat-form-field>
            <mat-form-field class="form-field-lg">
              <mat-label>FN</mat-label>
              <input [formControl]="field.controls.name" matInput />
            </mat-form-field>
            <mat-slide-toggle [formControl]="field.controls.isPublic" class="slide-toggle">
              {{ SharedLocalization.isPublic }}
            </mat-slide-toggle>
            <mat-slide-toggle [formControl]="field.controls.isStatic" class="slide-toggle">
              {{ SharedLocalization.isStatic }}
            </mat-slide-toggle>
          </ui-grid-block>
        }
      }
      <button (click)="addField()" class="button-lg button-secondary" mat-flat-button>
        {{ SharedLocalization.add }}
      </button>
    </ng-container>
  </card-container>
  <card-container>
    <ng-container heading>
      <h1>{{ RouteTitles.files }}</h1>
    </ng-container>
    <ng-container content>
      @if (!selectors.isFileBeingAdded()) {
        <ui-grid-block gridTemplateColumns="repeat(1, 1fr)">
          @for (file of form.controls.files.controls; track file) {
            <ui-flex-block flexAlignItems="center">
              <file-list-item
                [fileHref]="`files/${file.controls.id.value}`"
                [fileStorageType]="file.controls.fileStorageType.value"
                [name]="file.controls.name.value"
                [fileSize]="file.controls.fileSize.value | bytesToSize"
                [isPublic]="file.controls.isPublic.value"
                [isActive]="file.controls.isActive.value"
                [updated]="(file.controls.updated.value | date: 'short') ?? ''"
                style="flex: auto"
              />
              <button (click)="deleteFile($index)" class="icon-button-sm" mat-icon-button>
                <mat-icon class="icon-primary">delete_forever</mat-icon>
              </button>
            </ui-flex-block>
          } @empty {
            {{ SharedLocalization.noFiles }}
          }
        </ui-grid-block>
        <ui-flex-block>
          <button (click)="showFileUpload()" class="button-lg button-secondary" mat-flat-button>
            {{ FilesLocalization.uploadFile }}
          </button>
          <button (click)="showFileSelection()" class="button-lg button-secondary" mat-flat-button>
            {{ SharedLocalization.selectExisting }}
          </button>
        </ui-flex-block>
        @if (isUploadVisible()) {
          <file-upload (uploadCompleted)="addFileToTemplate($event)" />
        }
        @if (isFileSelectorVisible()) {
          <ui-grid-block gridTemplateColumns="repeat(1, 1fr)">
            <mat-form-field class="form-field-lg">
              @if (selectors.isFileListLoading()) {
                <mat-label>
                  <ui-flex-block flexJustifyContent="space-between">
                    <p>{{ SharedLocalization.loading }}</p>
                    <mat-spinner diameter="24"></mat-spinner>
                  </ui-flex-block>
                </mat-label>
              } @else {
                <mat-label>{{ SharedLocalization.pickAFile }}</mat-label>
              }
              <mat-select #select multiple>
                @for (file of selectors.fileList(); track file.id) {
                  <mat-option class="option-lg" [value]="file.id">{{ file.name }}</mat-option>
                } @empty {
                  {{ SharedLocalization.noFiles }}
                }
              </mat-select>
            </mat-form-field>
            <button
              (click)="addExistingFilesToTemplate(select.value ?? [])"
              class="button-lg button-secondary"
              mat-flat-button
            >
              {{ SharedLocalization.save }}
            </button>
          </ui-grid-block>
        }
      } @else {
        <ui-skeleton height="512" />
      }
    </ng-container>
  </card-container>
} @else {
  <ui-skeleton height="176" />
  <ui-skeleton height="262" />
  <ui-skeleton height="512" />
}
